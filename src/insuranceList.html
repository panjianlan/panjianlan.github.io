<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>风险防控</title>

<link rel="stylesheet" href="styles/common.css">
<link rel="stylesheet" href="styles/personalCenter.css">
<link rel="stylesheet" href="styles/new_ince.css">
<link rel="stylesheet" href="styles/insure.css">

<script type="text/javascript" src="stores/jquery-2.1.3.min.js"></script>

</head>
<body class="corrent">
<div class="wrap wrap_select" id="bxselect">	
	<header class='header new_header'>
		<div class='header-left'>
			<div class='icon-left-menu' onclick="gohome()"></div>
		</div>
		<h1 class='header-h1'>白城市医保管理中心</h1>
	</header>
	<article>
		<div class="new_detail_box new_detail_box_show">
			<div class="information">
				<div id="list" class="info_cont bg_base">
				</div>
			</div>
		</div>
	</article>
</div>	

</body>
<script>
//isBuy true 可以买
//险种列表 数据 结构
var data = {
			rows: [
				{id : "1",name:"城镇居民基本医疗保险",fee:"40",period:"2016/09/01 - 2017/08/30",isBuy:false,type:0},
				{id : "2",name:"补充医疗保险",fee:"30",period:"2016/09/01 - 2017/08/30",isBuy:false,type:1}
			]
		};
var fan;
$(function(){
	fan = new FAN();
	initProduct();
	initWX();
});
function initProduct(){
	A.showMask();
	var id = localStorage.getItem("STUID");
	$.ajax({
		url:"../../insure/queryProductList",
		type:"POST",
		data:{
			assuredId:id
		},
		dataType: "json",
		success:function(result){
			A.hideMask();
			if(!result.success){
				fan.showToast(errorTipMessage + "："+result.message);
				return;
			}
			if(result.rows==null || (result.rows!=null && result.rows.length==0)){
				fan.showToast(errorTipMessage);
				return;
			}
			var data = result ;
			var insuraceListString = JSON.stringify(data);
			var stuId = localStorage.getItem("STUID");
			var parmlist = "INSURANCE_LIST"+stuId;
			localStorage.removeItem(parmlist);
			localStorage.setItem(parmlist,insuraceListString);
		
		 /* 	data.rows[0].isBuy = true;//测试用
			data.rows[1].isBuy = false;//测试用 
			data.rows[0].expireDate =  '2016-10-01 00:00:00';//测试用
			data.rows[1].expireDate =  '2016-09-01 00:00:00';//测试用 */
			var template = Handlebars.compile($("#product-template").html());
			$('#list').html(template(data));
		}
	});

}
function openDetailsMerge(id,obj){
	var isBuy = $(obj).attr("data-isBuy");
	var photoUrl = $(obj).attr("data-img");
	var expireDate = $(obj).attr("data-expireDate");
	//alert(timestringToDate(expireDate))
	if(timestringToDate(expireDate)){
		A.alert('提示','通道已关闭');
		//A.showToast("通道已关闭");
		return;
	}
	
	if(!isBuy){
		A.alert('提示','您已经购买,不能重复购买');
		return;
	}
	
	var type= $(obj).attr("data-type");
	var name= $(obj).attr("data-name");
	var fee= $(obj).attr("data-fee");
	var currentObj = {
		insuranceId:id,
		fee:fee,
		insuranceName:name,
		type:type,
		photoUrl:photoUrl
	};
	
	
	var stuId = localStorage.getItem("STUID");
	var parmStr = "INSURANCE_DATA"+ stuId;
	var currentdataString = JSON.stringify(currentObj);
	localStorage.removeItem(parmStr);
	localStorage.setItem(parmStr,currentdataString);
	
	//window.location.href="insurance.html";return;
	
	//处理微信 刷新页面

	var appid;
	if(type == 0){
		appid = appIdObj.appId_base;
	}else if(type==1){
		appid = appIdObj.appId_bc;
	}
	var url = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=" + appid + "&redirect_uri="+  curentHref +"&response_type=code&scope=snsapi_base&state=123#wechat_redirect";
	localStorage.removeItem("INSURANCEHTML_URL");
	localStorage.setItem("INSURANCEHTML_URL",url);
	window.location.href = url;
}
function gohome()
{	
	var url = localStorage.getItem("INSURANCEHTML_INDEX");
	if(isEqual(url)){
		window.location.href=url;
		return;
	}
	window.location.href="index.html";
}

$(window).resize(function() {
	window.location.reload();
});

Handlebars.registerHelper('isShow', function(value, options) {
	
	 if(value == true) {
	     return "none";
	 } else {
	    return "block !important";
	 }
});

Handlebars.registerHelper('isShowfirst', function(value, options) {
	 if(timestringToDate(value) == true) {
	     return "block !important";
	 } else {
	    return "none";
	 }
});


Handlebars.registerHelper('showTxt', function(value, options) {
	return getexpiredateString(value);
});

Handlebars.registerHelper('showCss', function(value, options) {
	var csstxt = "";
	if (getexpiredateString(value).length>3){
		csstxt = "color:red";
	}
	else if(getexpiredateString(value)=="已关闭"){
		csstxt = "color: #fff;background: #666;height: 20px !important;line-height: 20px !important;padding: 3px 6px;border-radius: 3px;margin-top: 3px;";
	}
	else{
		csstxt = "";
	}
	return csstxt;
});
Handlebars.registerHelper('showCssPrice', function(value, options) {
	var csstxt = "";
	if (getexpiredateString(value).length>3){
		csstxt = "color:#ff9800";
	}
	else if(getexpiredateString(value)=="已关闭"){
		csstxt = "color: #999;";
	}
	else{
		csstxt = "";
	}
	return csstxt;
});
Handlebars.registerHelper('showCssName', function(value, options) {
	var csstxt = "";
	if (getexpiredateString(value).length>3){
		csstxt = "color:#333";
	}
	else if(getexpiredateString(value)=="已关闭"){
		csstxt = "color: #999;";
	}
	else{
		csstxt = "";
	}
	return csstxt;
});

Handlebars.registerHelper('showTotal1', function(value, options) {
	if(getexpiredateString(value)=="已关闭") {
		$.ajax({
			url:"../../insure/queryOrderCount",
			type:"POST",
			data:{
				type:1
			},
			dataType: "json",
			success:function(result){
				if(!result.success){
					fan.showToast(errorTipMessage + "："+result.message);
					return;
				}
				if(result.rows==null || (result.rows!=null && result.rows.length==0)){
					fan.showToast(errorTipMessage);
					return;
				}
				var txt = result.rows;
				$(".totalnum").html("已有&nbsp;&nbsp;" + txt + "&nbsp;&nbsp;人完成支付");
			}
		});
	}
});

Handlebars.registerHelper('showType1', function(value, options) {
	if(value == 1) {
	     return "block !important";
	 } else {
	    return "none";
	 }
	
});


</script>

<script id="product-template" type="text/x-handlebars-template">
	{{#each rows}}
		<a class="padding_1 border_20 productList" data-img="{{photoUrl}}" data-fee="{{fee}}" data-name="{{name}}" data-type="{{type}}" data-id="{{id}}" data-isBuy="{{isBuy}}" data-expireDate="{{expireDate}}" onClick="openDetailsMerge({{id}},this);">
			<div class="cont">
				<div class="imgbase"><img src="{{photoUrl}}" alt=""/></div>
				<div class="checkboxdiv" style="display:none;"><label class="simulateCheck" for="bcone"></label><input id="bcone" data-state="0" class="checkboximg" type="checkbox"/></div>
				<div class="info clearfix">
					<span class="title fl" style="{{showCssName expireDate}}">{{name}}}</span>
					<span class="title datetitle fl" style="{{showCss expireDate}}">{{showTxt expireDate}}</span>
					<span id="basePrice" class="title price fr" style="{{showCssPrice expireDate}}">¥{{fee}}</span>
				</div>
				<div class="info clearfix">
					<span class="title fl totalnum" style="display:none;word-wrap:break-word;word-break:break-all;font-size: 12px;color: #999;display:{{showType1 type}}">{{showTotal1 expireDate}}</span>
				</div>
			</div> 
			<div class="mask_list" style="display:{{isShow isBuy}};display:{{isShowfirst expireDate}};"></div>
			<p class="xjimg" style="height: calc(100%);display:{{isShowfirst expireDate}};"></p>
		</a>
	{{/each}}
</script>
</html>